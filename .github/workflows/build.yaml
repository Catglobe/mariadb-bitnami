name: Build

on:
  push:
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.head_ref || github.ref }}
  cancel-in-progress: true 

jobs:
  Build:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout
      uses: actions/checkout@692973e3d937129bcbf40652eb9f2f61becf3332 # v4
    - name: Set up QEMU
      uses: docker/setup-qemu-action@5927c834f5b4fdf503fca6f4c7eccda82949e1ee # v3
    
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@4fd812986e6c8c2a69e18311145f9371337f27d4 # v3
    - name: Log in to the Container registry
      uses: docker/login-action@9780b0c442fbb1117ed29e0efdff1e18412f7567 # v3
      with:
        registry: docker.io
        username: ${{ secrets.DOCKER_USERNAME }}
        password: ${{ secrets.DOCKER_TOKEN }}
    #extract the version from the Dockerfile to match the FROM bitnami/mariadb:11.2.4-debian-12-r42@SHA... -> 11.2.4-debian-12-r42
    - name: Extract version
      id: extract_version

      run: echo img_version=$(grep -oP 'FROM bitnami/mariadb:\K[^@\s]+' Dockerfile) >> $GITHUB_ENV
    - name: Build
      uses: docker/build-push-action@5176d81f87c23d6fc96624dfdbcd9f3830bbe445 # v6
      with:
        #only push for main branch
        push: ${{ github.ref == 'refs/heads/main' }}
        platforms: ${{ github.ref == 'refs/heads/main' && 'linux/amd64,linux/arm64' || 'linux/amd64' }}
        labels: |
          org.opencontainers.image.title=Voxmeter MariaDB
          org.opencontainers.image.description=Voxmeter MariaDB
          org.opencontainers.image.vendor=Voxmeter A/S
          org.opencontainers.image.licenses=MIT
        tags: |
          ${{ secrets.DOCKER_USERNAME }}/mariadb:${{ env.img_version }}
    